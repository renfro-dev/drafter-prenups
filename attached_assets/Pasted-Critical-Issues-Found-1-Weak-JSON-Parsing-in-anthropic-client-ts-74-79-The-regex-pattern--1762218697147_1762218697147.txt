Critical Issues Found:

  1. Weak JSON Parsing in anthropic-client.ts:74-79 âš ï¸

  The regex pattern /\{[\s\S]*\}/ is greedy and will match the FIRST { to the LAST }, which can fail if:
  - Claude includes multiple JSON objects in the response
  - There's text after the JSON
  - The response contains nested objects with extra closing braces

  Fix:
  // Use non-greedy matching
  const jsonMatch = textContent.text.match(/\{[\s\S]*?\}/);
  // OR better yet, find first { and last }
  const firstBrace = textContent.text.indexOf('{');
  const lastBrace = textContent.text.lastIndexOf('}');
  if (firstBrace === -1 || lastBrace === -1) {
    throw new Error('No JSON found in response');
  }
  const jsonStr = textContent.text.substring(firstBrace, lastBrace + 1);
  const result = JSON.parse(jsonStr);

  2. Missing Error Details in document-generator.ts:11-13 ðŸ›

  When PII map keys aren't found, you're silently falling back to defaults without logging:
  const partyA = piiMap.names[Object.keys(piiMap.names).find(k => k.startsWith('PARTY_A_')) || ''] || 'Party A';

  This could fail silently if the masking tokens don't exist. Add logging:
  const partyAKey = Object.keys(piiMap.names).find(k => k.startsWith('PARTY_A_'));
  if (!partyAKey) {
    console.error('[Document Generator] WARNING: No PARTY_A token found in piiMap.names');
  }
  const partyA = partyAKey ? piiMap.names[partyAKey] : 'Party A';

  3. Unescaped Regex Special Characters in pii-masking.ts:87-104 ðŸ”¥

  The tokens contain underscores and potentially other regex special characters that aren't escaped:
  const regex = new RegExp(token, 'g');

  Tokens like PARTY_A_12AB34CD contain underscores which are fine, but if UUIDs ever contain regex metacharacters like ., +,
  *, ?, etc., this will break.

  Fix:
  const regex = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');

  4. No Validation on AI Response Structure ðŸ’¥

  Lines 82-84 in anthropic-client.ts assume result.jurisdiction and result.sections exist but don't validate them:
  return {
    jurisdiction: result.jurisdiction || 'CA',
    sections: result.sections || [],
  };

  If Claude returns malformed JSON like {"jurisdiction": "CA"} (missing sections), you'll pass an empty sections array which
  will create a blank document.

  Add validation:
  if (!result.sections || !Array.isArray(result.sections) || result.sections.length === 0) {
    throw new Error('Invalid AI response: missing or empty sections array');
  }

  5. Potential Database Issue - No Clauses Found

  server/routes.ts:455-457 will throw if no clauses exist for the jurisdiction. Check your database:
  SELECT * FROM clauses WHERE jurisdiction = 'CA';

  Quick Diagnosis Steps:

  1. Check if clauses exist in DB:
  psql $DATABASE_URL -c "SELECT COUNT(*) FROM clauses WHERE jurisdiction = 'CA';"
  2. Add debug logging to see where it fails:
    - Add console.log(textContent.text) before line 74 in anthropic-client.ts
    - Add console.log(piiMap) before line 6 in document-generator.ts
  3. Test the unmask function - the issue might be that tokens aren't being replaced because they don't match exactly